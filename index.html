<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PicFit â€” Take a pic. Get your fit.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark">
  <script>
    // Load environment variables (in production, this would be handled by a build process)
    
  </script>
  <style>
    /* Developer Notes (read me):
       - Toggle mock mode by adding ?mock=1 to the URL. In mock mode, we skip API/Stripe and use sample images.
       - To wire Stripe: set STRIPE_PUBLISHABLE_KEY and CHECKOUT_SESSION_ENDPOINT below (client calls your server).
       - To wire Gemini: implement /api/fit (multipart) and return an image (jpeg/png). See JS section 'generateWithServer'.
       - LocalStorage key 'picfit_used_once' gates the free trial.
       - This file is intentionally single-file vanilla JS + Tailwind (no build step). */
    .glass { background: rgba(0,0,0,0.8); backdrop-filter: blur(6px); }
    .ring-smooth:focus { outline:none; box-shadow:0 0 0 3px rgba(255,255,255,0.5); }
    .clip-after { clip-path: inset(0 50% 0 0); }
    .modern-button {
      @apply bg-white text-black font-bold border-2 border-black transition-all duration-200;
    }
    .modern-button:hover {
      @apply bg-black text-white;
    }
    .modern-card {
      @apply bg-white text-black border-2 border-black;
    }
  </style>
</head>
<body class="min-h-screen bg-white text-black">
  <header class="max-w-4xl mx-auto px-4 py-6 flex items-center justify-between">
    <div class="text-2xl font-black tracking-tight">Pic<span class="text-black">Fit</span>.ai</div>
    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-600 hidden sm:inline">First fit is free</span>
      <button id="howBtn" class="text-sm px-4 py-2 modern-button rounded-none">How it works</button>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 space-y-6 pb-16">
    <!-- Hero -->
    <section class="modern-card rounded-none p-6">
      <h1 class="text-3xl sm:text-4xl font-black mb-4">Take a pic. Get your fit.</h1>
      <p class="text-gray-700 text-base mb-6">Upload multiple standing photos of yourself and 1â€“5 outfit pics (flat lay). PicFit previews the outfit on you. First result is free. After that, buy a fit pack.</p>
      
      <!-- Instructions List -->
      <div class="space-y-4 mb-6">
        <div class="modern-card rounded-none p-4">
          <h2 class="font-bold mb-2 text-lg">1) Multiple Standing Photos</h2>
          <p class="text-gray-700 text-sm">Take 3-5 full-body photos from different angles (front, side, back). Good lighting, face visible, no sunglasses. This helps us understand your body shape better.</p>
        </div>
        <div class="modern-card rounded-none p-4">
          <h2 class="font-bold mb-2 text-lg">2) Outfit Flat Lay</h2>
          <p class="text-gray-700 text-sm">1â€“5 items in one shot. More context â†’ better fit. Lay clothes flat on a clean surface.</p>
        </div>
        <div class="modern-card rounded-none p-4">
          <h2 class="font-bold mb-2 text-lg">3) Generate</h2>
          <p class="text-gray-700 text-sm">First fit's free. Then choose a pack.</p>
        </div>
      </div>

      <!-- Example images -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="space-y-2">
          <div class="text-sm font-semibold">Your photos (example)</div>
          <div class="aspect-[3/4] border-2 border-black overflow-hidden">
            <img src="images/person.png" alt="Example standing photo" class="w-full h-full object-cover">
          </div>
        </div>
        <div class="space-y-2">
          <div class="text-sm font-semibold">Outfit (example)</div>
          <div class="aspect-[3/4] border-2 border-black overflow-hidden">
            <img src="images/outfit.png" alt="Example outfit flat lay" class="w-full h-full object-cover">
          </div>
        </div>
      </div>
    </section>

    <!-- Uploaders -->
    <section class="modern-card rounded-none p-6 space-y-4">
      <h2 class="text-xl font-bold">Upload Your Photos</h2>
      
      <!-- Standing Photos Upload -->
      <div class="space-y-3">
        <div class="text-sm font-semibold">Standing Photos (3-5 recommended)</div>
        <div id="standingDropZone" class="border-2 border-dashed border-black p-6 text-center hover:bg-gray-50 transition-colors">
          <div class="text-2xl mb-2">ðŸ“¸</div>
          <div class="text-sm">Drop standing photos here or click to browse</div>
          <input type="file" id="standingInput" multiple accept="image/*" class="hidden">
        </div>
        <div id="standingPreview" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
      </div>

      <!-- Outfit Upload -->
      <div class="space-y-3">
        <div class="text-sm font-semibold">Outfit Flat Lay (1-5 items)</div>
        <div id="outfitDropZone" class="border-2 border-dashed border-black p-6 text-center hover:bg-gray-50 transition-colors">
          <div class="text-2xl mb-2">ðŸ‘•</div>
          <div class="text-sm">Drop outfit photo here or click to browse</div>
          <input type="file" id="outfitInput" accept="image/*" class="hidden">
        </div>
        <div id="outfitPreview" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
      </div>

      <div class="flex gap-3 pt-4">
        <button id="genBtn" class="flex-1 py-3 modern-button rounded-none text-lg">Generate my fit</button>
        <button id="resetBtn" class="px-6 py-3 modern-button rounded-none">Reset</button>
      </div>
    </section>

    <!-- Result -->
    <section id="resultSection" class="modern-card rounded-none p-6 space-y-4 hidden">
      <h2 class="text-xl font-bold">Your Generated Fit</h2>
      <div id="resultContainer" class="space-y-4">
        <!-- Result will be inserted here -->
      </div>
      <div class="flex gap-3">
        <button id="downloadBtn" class="flex-1 py-3 modern-button rounded-none">Download</button>
        <button id="shareBtn" class="px-6 py-3 modern-button rounded-none">Share</button>
      </div>
    </section>
  </main>

  <!-- Payment Modal -->
  <div id="paymentModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50">
    <div class="modern-card rounded-none p-6 max-w-md w-full">
      <h3 class="text-xl font-bold mb-4">Choose a Fit Pack</h3>
      <div id="pricingOptions" class="space-y-3 mb-6">
        <!-- Pricing options will be inserted here -->
      </div>
      <div class="flex gap-3">
        <button id="cancelBtn" class="flex-1 py-2 modern-button rounded-none">Cancel</button>
      </div>
    </div>
  </div>

  <!-- How it works modal -->
  <div id="howModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden z-50">
    <div class="modern-card rounded-none p-6 max-w-lg w-full">
      <h3 class="text-xl font-bold mb-4">How PicFit Works</h3>
      <div class="space-y-4 text-sm">
        <div>
          <h4 class="font-semibold mb-2">1. Upload Multiple Standing Photos</h4>
          <p class="text-gray-700">Take 3-5 full-body photos from different angles. This helps our AI understand your body shape and proportions better.</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">2. Upload Outfit Flat Lay</h4>
          <p class="text-gray-700">Lay out 1-5 clothing items flat on a clean surface and take a photo. More items provide better context for styling.</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">3. AI Generation</h4>
          <p class="text-gray-700">Our AI analyzes your photos and the outfit to create a realistic preview of how the clothes will look on you.</p>
        </div>
        <div>
          <h4 class="font-semibold mb-2">4. Get Your Fit</h4>
          <p class="text-gray-700">Download or share your generated fit preview. First generation is free!</p>
        </div>
      </div>
      <button id="closeHowBtn" class="w-full py-2 modern-button rounded-none mt-6">Got it</button>
    </div>
  </div>

  <script>
    // Configuration
    const STRIPE_PUBLISHABLE_KEY = ''; // Set your Stripe publishable key
    const CHECKOUT_SESSION_ENDPOINT = ''; // Set your checkout session endpoint
    // Load API key from environment or use fallback
    const GEMINI_API_KEY = window.GEMINI_API_KEY;
    const MOCK_MODE = new URLSearchParams(window.location.search).get('mock') === '1';

    // State
    let standingPhotos = [];
    let outfitPhoto = null;
    let hasUsedFreeTrial = localStorage.getItem('picfit_used_once') === 'true';

    // DOM elements
    const standingInput = document.getElementById('standingInput');
    const outfitInput = document.getElementById('outfitInput');
    const standingDropZone = document.getElementById('standingDropZone');
    const outfitDropZone = document.getElementById('outfitDropZone');
    const standingPreview = document.getElementById('standingPreview');
    const outfitPreview = document.getElementById('outfitPreview');
    const genBtn = document.getElementById('genBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultSection = document.getElementById('resultSection');
    const resultContainer = document.getElementById('resultContainer');
    const paymentModal = document.getElementById('paymentModal');
    const howModal = document.getElementById('howModal');
    const howBtn = document.getElementById('howBtn');
    const closeHowBtn = document.getElementById('closeHowBtn');

    // Event listeners
    standingInput.addEventListener('change', handleStandingFiles);
    outfitInput.addEventListener('change', handleOutfitFile);
    standingDropZone.addEventListener('click', () => standingInput.click());
    outfitDropZone.addEventListener('click', () => outfitInput.click());
    standingDropZone.addEventListener('dragover', handleDragOver);
    standingDropZone.addEventListener('drop', handleStandingDrop);
    outfitDropZone.addEventListener('dragover', handleDragOver);
    outfitDropZone.addEventListener('drop', handleOutfitDrop);
    genBtn.addEventListener('click', generateFit);
    resetBtn.addEventListener('click', resetAll);
    howBtn.addEventListener('click', () => howModal.classList.remove('hidden'));
    closeHowBtn.addEventListener('click', () => howModal.classList.add('hidden'));

    // File handling
    function handleStandingFiles(e) {
      const files = Array.from(e.target.files);
      standingPhotos = [...standingPhotos, ...files].slice(0, 10); // Max 10 photos
      updateStandingPreview();
    }

    function handleOutfitFile(e) {
      const file = e.target.files[0];
      if (file) {
        outfitPhoto = file;
        updateOutfitPreview();
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
    }

    function handleStandingDrop(e) {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
      standingPhotos = [...standingPhotos, ...files].slice(0, 10);
      updateStandingPreview();
    }

    function handleOutfitDrop(e) {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        outfitPhoto = file;
        updateOutfitPreview();
      }
    }

    function updateStandingPreview() {
      standingPreview.innerHTML = '';
      standingPhotos.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'relative group';
          div.innerHTML = `
            <img src="${e.target.result}" class="w-full h-24 object-cover border-2 border-black">
            <button onclick="removeStandingPhoto(${index})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600">Ã—</button>
          `;
          standingPreview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    function updateOutfitPreview() {
      outfitPreview.innerHTML = '';
      if (outfitPhoto) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'relative group';
          div.innerHTML = `
            <img src="${e.target.result}" class="w-full h-32 object-cover border-2 border-black">
            <button onclick="removeOutfitPhoto()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600">Ã—</button>
          `;
          outfitPreview.appendChild(div);
        };
        reader.readAsDataURL(outfitPhoto);
      }
    }

    function removeStandingPhoto(index) {
      standingPhotos.splice(index, 1);
      updateStandingPreview();
    }

    function removeOutfitPhoto() {
      outfitPhoto = null;
      updateOutfitPreview();
    }

    // Generation
    async function generateFit() {
      if (standingPhotos.length === 0 || !outfitPhoto) {
        alert('Please upload at least one standing photo and one outfit photo.');
        return;
      }

      genBtn.disabled = true;
      genBtn.textContent = 'Generating...';

      try {
        if (MOCK_MODE) {
          // Mock generation
          await new Promise(resolve => setTimeout(resolve, 2000));
          showMockResult();
        } else {
          await generateWithServer();
        }
      } catch (error) {
        console.error('Generation failed:', error);
        alert('Generation failed. Please try again.');
      } finally {
        genBtn.disabled = false;
        genBtn.textContent = 'Generate my fit';
      }
    }

    function showMockResult() {
      resultContainer.innerHTML = `
        <div class="text-center">
          <div class="text-6xl mb-4">âœ¨</div>
          <h3 class="text-lg font-bold mb-2">Your Generated Fit</h3>
          <div class="aspect-[3/4] bg-gray-100 border-2 border-black flex items-center justify-center mb-4">
            <div class="text-center">
              <div class="text-4xl mb-2">ðŸ‘”</div>
              <div class="text-sm text-gray-600">Generated fit preview</div>
            </div>
          </div>
          <p class="text-sm text-gray-700">This is a mock result. In production, this would show your actual generated fit.</p>
        </div>
      `;
      resultSection.classList.remove('hidden');
    }

    async function generateWithServer() {
      try {
        // Convert images to base64 for Gemini API
        const standingPhotosB64 = await Promise.all(
          standingPhotos.map(photo => convertToBase64(photo))
        );
        const outfitPhotoB64 = await convertToBase64(outfitPhoto);

        // Use Gemini to generate the virtual try-on image
        const generatedImage = await generateImageWithGemini(standingPhotosB64, outfitPhotoB64);
        
        // Display the generated image
        showGeneratedImage(generatedImage);
        
      } catch (error) {
        console.error('Gemini API error:', error);
        console.error('Error details:', error.message);
        throw new Error(`Image generation failed: ${error.message}`);
      }
    }

    async function convertToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:image/jpeg;base64, prefix
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function generateImageWithGemini(standingPhotosB64, outfitPhotoB64) {
      const prompt = `Task: Virtual try-on composition.

Use the exact person from the first image (fullâ€‘body standing photo). Preserve their identity, pose, body proportions, hair, skin tone, facial features. Camera perspective should be standing facing the camera like a model. Pay close attention to the face shape and eyes to try to make them look exactly like the person in the standing photo.

From the second image (flatâ€‘lay outfit), identify each clothing item and accessories (top, bottoms, shoes, bag, scarf, jewelry). Dress the person in those exact items with realistic fit, fabric behavior, and layering. Maintain correct scale, drape, and contact points at shoulders, waist, hips, and feet. Keep all garment textures, colors, and details accurate.

Background: Replace with a photorealistic bright outdoor scene (parklet/patio/garden vibe). Natural, slightly directional daylight; soft shadows; no other people.

Output: A single photorealistic image of the same person now wearing the outfit from the flatâ€‘lay. Frame like professional fashion photography. Person should be facing the camera like a model. Avoid artifacts, misalignment, or extra items.

When you make the output, make sure to double check that all the items you identified in the flatâ€‘lay photo are present in the output image. Remove any other items that are not in the flatâ€‘lay photo, like hats, or phones (no selfies or phones)`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            role: 'user',
            parts: [
              { text: prompt },
              { inline_data: { mime_type: 'image/jpeg', data: standingPhotosB64[0] } },
              { inline_data: { mime_type: 'image/jpeg', data: outfitPhotoB64 } }
            ]
          }]
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('API Response Error:', response.status, errorText);
        throw new Error(`Gemini API error: ${response.status} - ${errorText}`);
      }

      const data = await response.json();
      console.log('Gemini API Response:', data);
      console.log('Full response structure:', JSON.stringify(data, null, 2));
      
      // Check if there's an error in the response
      if (data.error) {
        throw new Error(`Gemini API error: ${data.error.message || 'Unknown error'}`);
      }
      
      // Check if Gemini returned an image
      if (data.images && data.images.length > 0) {
        console.log('Found generated image!');
        return `data:image/jpeg;base64,${data.images[0]}`;
      } else if (data.candidates && data.candidates[0] && data.candidates[0].content) {
        const content = data.candidates[0].content;
        console.log('Response content:', content);
        
        // parts may include inlineData or inline_data depending on casing
        if (content.parts && Array.isArray(content.parts)) {
          for (let part of content.parts) {
            // Newer SDK-style: inlineData { mimeType, data }
            if (part.inlineData && part.inlineData.data) {
              const mime = part.inlineData.mimeType || 'image/jpeg';
              return `data:${mime};base64,${part.inlineData.data}`;
            }
            // REST style: inline_data { mime_type, data }
            if (part.inline_data && part.inline_data.data) {
              const mime = part.inline_data.mime_type || 'image/jpeg';
              return `data:${mime};base64,${part.inline_data.data}`;
            }
            // Some responses may place raw base64 under image/bytes fields
            const b64 = part.image_data || part.imageData || part.image || part.bytes;
            if (b64) {
              return `data:image/jpeg;base64,${b64}`;
            }
          }
        }
      }
      
      // If we got a text response, show it for debugging
      if (data.text || (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.text)) {
        const text = data.text || data.candidates[0].content.text;
        console.log('Gemini text response:', text);
        showTextResponse(text);
        return;
      }
      
      // If no image was generated, throw an error
      throw new Error('Gemini did not generate an image. Check console for details.');
    }

    function showGeneratedImage(imageDataUrl) {
      resultContainer.innerHTML = `
        <div class="space-y-4">
          <div class="text-center">
            <div class="text-6xl mb-4">âœ¨</div>
            <h3 class="text-lg font-bold mb-2">Your Virtual Try-On</h3>
          </div>
          
          <div class="text-center">
            <img src="${imageDataUrl}" alt="Generated virtual try-on" class="w-full max-w-md mx-auto border-2 border-black rounded-none">
          </div>
          
          <div class="text-center text-sm text-gray-600">
            <p>Generated by Gemini AI - showing how the outfit would look on you!</p>
          </div>
        </div>
      `;
      resultSection.classList.remove('hidden');
    }

    function showTextResponse(text) {
      resultContainer.innerHTML = `
        <div class="space-y-4">
          <div class="text-center">
            <div class="text-6xl mb-4">ðŸ¤–</div>
            <h3 class="text-lg font-bold mb-2">Gemini Analysis</h3>
          </div>
          
          <div class="modern-card rounded-none p-4">
            <h4 class="font-bold mb-3">AI Response:</h4>
            <div class="text-sm text-gray-700 whitespace-pre-wrap">${text}</div>
          </div>
          
          <div class="text-center text-sm text-gray-600">
            <p>Note: Gemini 2.0 Flash doesn't support image generation yet. This is the text analysis response.</p>
          </div>
        </div>
      `;
      resultSection.classList.remove('hidden');
    }

    function resetAll() {
      standingPhotos = [];
      outfitPhoto = null;
      standingInput.value = '';
      outfitInput.value = '';
      updateStandingPreview();
      updateOutfitPreview();
      resultSection.classList.add('hidden');
    }

    // Payment handling
    function showPaymentModal() {
      if (hasUsedFreeTrial) {
        const pricingOptions = [
          { label: '5 Fits', qty: 5, unit: 0.50 },
          { label: '10 Fits', qty: 10, unit: 0.45 },
          { label: '25 Fits', qty: 25, unit: 0.40 },
          { label: '50 Fits', qty: 50, unit: 0.35 }
        ];

        const pricingHtml = pricingOptions.map(t => {
          const price = t.qty * t.unit * 1.4; // 40% markup
          const per = (price / t.qty).toFixed(2);
          return `
            <div class="flex items-center justify-between p-3 border-2 border-black">
              <div>
                <div class="font-semibold">${t.label}</div>
                <div class="text-xs text-gray-600">$${per} per fit</div>
              </div>
              <button class="px-4 py-2 modern-button rounded-none"
                      onclick="checkout('${t.label}', ${t.qty}, ${price.toFixed(2)})">
                Buy $${price.toFixed(2)}
              </button>
            </div>
          `;
        }).join('');

        document.getElementById('pricingOptions').innerHTML = pricingHtml;
        paymentModal.classList.remove('hidden');
      }
    }

    async function checkout(label, qty, price) {
      if (!STRIPE_PUBLISHABLE_KEY || !CHECKOUT_SESSION_ENDPOINT) {
        alert('Payment not configured. This is a demo.');
        return;
      }

      try {
        const response = await fetch(CHECKOUT_SESSION_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, qty, price })
        });

        const session = await response.json();
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        await stripe.redirectToCheckout({ sessionId: session.id });
      } catch (error) {
        console.error('Checkout failed:', error);
        alert('Checkout failed. Please try again.');
      }
    }

    // Initialize
    if (hasUsedFreeTrial) {
      genBtn.addEventListener('click', showPaymentModal);
    }
  </script>
</body>
</html>
