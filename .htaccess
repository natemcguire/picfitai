# --- PHP limits (DreamHost Apache + PHP-FPM honors these) ---
php_value upload_max_filesize 50M
php_value post_max_size 100M
php_value max_file_uploads 20
php_value max_execution_time 300
php_value max_input_time 300
php_value memory_limit 256M
php_flag  file_uploads On

# --- Security headers ---
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "DENY"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# --- Block sensitive files (Apache 2.4 syntax) ---
# .env, config*, bootstrap*, composer files, VCS, etc.
<FilesMatch "^(\.env|composer\.(json|lock)|\.git|config|bootstrap)">
  Require all denied
</FilesMatch>

# Never serve dotfiles
<FilesMatch "^\.(?!well-known/)">
  Require all denied
</FilesMatch>

# --- Routing ---
DirectoryIndex index.php

<IfModule mod_rewrite.c>
  RewriteEngine On

  # Special share route: /share/<32-hex>
  RewriteRule ^share/([a-f0-9]{32})/?$ share.php?token=$1 [QSA,L]

  # If request is an existing file or dir, serve it
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # “No extension” → try matching PHP file (e.g., /upload -> upload.php)
  RewriteCond %{REQUEST_FILENAME}.php -f
  RewriteRule ^(.+)$ $1.php [QSA,L]
</IfModule>

# --- Caching for static assets ---
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css                 "access plus 1 month"
  ExpiresByType application/javascript   "access plus 1 month"
  ExpiresByType image/png                "access plus 1 month"
  ExpiresByType image/jpeg               "access plus 1 month"
  ExpiresByType image/gif                "access plus 1 month"
  ExpiresByType image/webp               "access plus 1 month"
</IfModule>

# --- Compression ---
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css \
    application/xml application/xhtml+xml application/rss+xml \
    application/javascript application/x-javascript
</IfModule>

# --- Force HTTPS (enable after cert is on) ---
# <IfModule mod_rewrite.c>
#   RewriteEngine On
#   RewriteCond %{HTTPS} !=on
#   RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>
